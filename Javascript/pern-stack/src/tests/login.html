<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    :root {
      color-scheme: dark light;
    }
    input {
      padding: 6px;
      border: 1px solid #333;
    }
    html {
      margin: 0;
      padding: 0;
    }
  </style>
  <body>
    <main style="display: flex; height: 100dvh">
      <section
        style="
          display: flex;
          flex-direction: column;
          border: 1px solid #333;
          justify-content: center;
          margin: auto;
          padding: 36px;
        "
      >
        <h3 style="text-align: center">Inicio de sesión</h3>
        <div id="result"></div>
        <button id="logout" style="display: none;">Cerrar sesion</button>
        <form
          style="
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
          "
        >
          <label for="email">
            <input name="email" type="text" placeholder="Email" />
          </label>
          <label for="password">
            <input name="password" type="password" placeholder="•••••••" />
          </label>
          <button type="submit" style="padding: 6px 8px">Ingresar</button>
          <a href="">¿Olvidaste la contraseña?</a>
        </form>
      </section>
    </main>
    <script type="module">
      (async () => {
        document.addEventListener("DOMContentLoaded", () => {
          const form = document.querySelector("form");

          form.onsubmit = async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const email = formData.get("email");
            const password = formData.get("password");

            const res = await fetch("http://localhost:5000/api/signin", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });
            const data = await res.json();
            const info = data.user;
            if (!res.ok) {
                alert(data.message)
                return;
            }
            form.remove();
            const result = document.getElementById("result");
            const logoutButton = document.getElementById("logout")
            if (result && logoutButton) {
                logoutButton.style.display = "block"
                result.innerHTML = `
                <div>
                  <img src="${info.user_avatar}" width="45" height="45" style="border-radius: 50%;" />
                </div>
                <p>Usuario: ${info.user_name}</p>
                <p>Email: ${info.user_email}</p>
                <time>Creado el ${new Date(
                    info.created_at
                ).toLocaleDateString()}</time>
                `;
                logoutButton.onclick = async () => {
                    await fetch("http://localhost:5000/api/signout", {
                        method: "GET",
                        headers: { "Content-Type": "application/json" },
                        credentials: "include",
                    }).then((res) => res.json()).then((data) => {
                        result.remove()
                        logoutButton.remove()
                        document.querySelector("section").appendChild(form)
                        alert(data.message)
                    }).catch((err) => console.log(err))
                } 
            }
          };
        });
      })();
    </script>
  </body>
</html>
